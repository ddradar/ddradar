name: Apply milestone to PRs

on:
  pull_request:
    types: [opened, reopened, edited, ready_for_review]

permissions:
  issues: write
  pull-requests: write

jobs:
  apply-milestone:
    runs-on: ubuntu-latest
    if: github.event.pull_request.milestone == null
    steps:
      - name: Apply milestone to PR
        uses: actions/github-script@v8
        env:
          CURRENT_MILESTONE: ${{ vars.CURRENT_MILESTONE }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const milestoneNumber = Number(process.env.CURRENT_MILESTONE || '');
            if (!Number.isInteger(milestoneNumber) || milestoneNumber <= 0) {
              core.warning(`CURRENT_MILESTONE is not a valid milestone number: "${process.env.CURRENT_MILESTONE}"; skipping.`);
              return;
            }
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            try {
              await github.rest.issues.update({ owner, repo, issue_number, milestone: milestoneNumber });
              core.debug(`Applied milestone #${milestoneNumber} to PR #${issue_number}`);
            } catch (err) {
              core.setFailed(`Failed to apply milestone: ${err.message ?? err}`);
            }
